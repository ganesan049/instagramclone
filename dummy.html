import React, {
    useState,
    useEffect,
    useReducer,
    createContext,
    useContext,
  } from "react";
  import { appendSpreadsheet } from "./GoogleSheetData";
  import QuizReducer from "../reducers/QuizReducer";
  import Answers from "./Answers";
  import Question from "./Question";
  import {
    SET_ANSWERS,
    SET_CURRENT_QUESTION,
    SET_CURRENT_ANSWER,
    SET_ERROR,
    SET_SHOW_RESULTS,
    RESET_QUIZ,
  } from "../reducers/types";
  import Progress from "./Progress";
  export const QuizContext = createContext();
  const QuizCreate = ({ questions }) => {
    const initialState = {
      questions,
      currentQuestion: 0,
      currentAnswer: "",
      answers: [],
      showResults: false,
      error: "",
    };
    const [state, dispatch] = useReducer(QuizReducer, initialState);
    useEffect(() => {}, [state]);
    const { currentQuestion, currentAnswer, answers, showResults, error } = state;
    console.log(state);
    const question = questions[currentQuestion];
    const renderError = () => {
      if (!error) {
        return;
      }
  
      return <div className="error">{error}</div>;
    };
    //   let answers = []
    const next = (e) => {
      const answer = { questionId: question.id, answer: currentAnswer };
      console.log(answer, state);
      if (!currentAnswer) {
        dispatch({ type: SET_ERROR, value: "Please Select a option" });
        return;
      }
      answers.push(answer);
      dispatch({ type: SET_ANSWERS, value: answers });
      dispatch({ type: SET_CURRENT_ANSWER, value: "" });
      if (currentQuestion + 1 < questions.length) {
        dispatch({ type: SET_CURRENT_QUESTION, value: currentQuestion + 1 });
        return;
      }
      dispatch({ type: SET_SHOW_RESULTS, value: true });
    };
  
    const renderResultMark = (question, answer) => {
      console.log(
        question.correct_answer,
        answer.answer,
        question.correct_answer.trim().length,
        answer.answer.length,
        typeof question.correct_answer,
        typeof answer.answer
      );
  
      if (question.correct_answer.trim() === answer.answer.trim()) {
        console.log("returning correct");
        return <span className="correct">Correct</span>;
      }
  
      return <span className="failed">Failed</span>;
    };
    const renderResultsData = () => {
      return answers.map((answer) => {
        console.log(answer);
        console.log(questions);
        //   const question = questions.find(
        //     (question) => {question.id === answer.questionID}
        //   );
        let question;
        questions.forEach((currentQuestion) => {
          console.log(currentQuestion.id, answer.questionId);
          if (currentQuestion.id === answer.questionId) {
            question = currentQuestion;
          }
        });
        console.log(question);
        return (
          <div key={question.id}>
            {question.question} - {renderResultMark(question, answer)}
          </div>
        );
      });
    };
    if (showResults) {
      return (
        <div className="container results">
          <h2>Results</h2>
          <ul>{renderResultsData()}</ul>
          {/* <button className="btn btn-primary" onClick={restart}>
            Restart
          </button> */}
        </div>
      );
      // return <div>Answers Submitted Successfully</div>;
    } else {
      return (
        <QuizContext.Provider value={{ state, dispatch }}>
          <div className="container">
            {/* <Progress total={questions.length} current={currentQuestion + 1} /> */}
            <Question />
            {renderError()}
            <Answers />
            <button className="btn btn-primary" onClick={(e) => next(e)}>
              Confirm and Continue
            </button>
          </div>
        </QuizContext.Provider>
      );
    }
  };
  const Quiz = () => {
    const [data, setdata] = useState(null);
    let makeDataFull = (array) => {
      let makeObj = (data, id) => {
        return {
          id,
          question: data[0],
          answer_a: data[1],
          answer_b: data[2],
          answer_c: data[3],
          answer_d: data[4],
          correct_answer: data[5],
        };
      };
      let final = [];
      array.forEach((data, i) => {
        final.push(makeObj(data, i + 1));
      });
      return final;
    };
    useEffect(() => {
      appendSpreadsheet(2).then((value) => {
        setdata(makeDataFull(value));
      });
    }, []);
    let display = () => {
      console.log(data);
      if (data) return <QuizCreate questions={data} />;
      return <div>no questions</div>;
    };
    return <div>{display()}</div>;
  };
  
  export default Quiz;
  